<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skynet Knowledge Engine â€” Results</title>
  <style>
    :root {
      --fg:#f2f2f2; --muted:#b3b3b3;
      --card:#141414; --radius:14px; --border:#2a2a2a;
      --accent:#ffffff;
      --accent-rgb: 255, 255, 255; /* RGB values for rgba() */
      --accent-light:#f0f0f0;     /* lighter accent for gradients */
      --bg-secondary:#1a1a1a;     /* secondary background */
      --focus:#EFF9F0;
    }
    body{
      margin:0; background:#000; color:var(--fg);
      font-family: Arial, sans-serif;
      min-height:100vh; display:flex; flex-direction:column;
      background-image:
        linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,.65)),
        url("Spacebackground.jpg");
      background-position:center; background-size:cover;
      background-repeat:no-repeat; background-attachment:fixed;
    }
    .topbar{ display:flex; align-items:center; justify-content:space-between; padding:10px 16px; }
    .brand-link{
      display:flex; align-items:center; gap:10px;
      text-decoration:none;
    }
    .brand-logo{ height:22px; width:auto; object-fit:contain; border-radius:3px; }
    .brand-text{ color:var(--muted); font-size:.95rem; }
    .top-right{ display:flex; align-items:center; gap:10px; }
    .btn-link{
      border:1px solid var(--border); background:transparent; color:#e6e6e6;
      padding:.4rem .7rem; border-radius:9999px; cursor:pointer; font-size:.85rem;
    }
    .btn-link:hover{ background:#1a1a1a; }
    .wrap{
      max-width:960px;
      margin:0 auto;
      padding:16px 16px 128px;
      width:100%;
    }
    .centered-search {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
    }
    .searchbar {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }
    .searchbar input {
      flex: 1;
      padding: 14px 16px;
      border-radius: 9999px;
      border: 2px solid #2a2a2a;
      background: #121212;
      color: #f2f2f2;
      font-size: 1.1rem;
      outline: none;
    }
    .btn{
      border:none; border-radius:9999px; background:var(--accent); color:#000;
      font-weight:700; padding:12px 18px; font-size:1.1rem; cursor:pointer;
    }
    .btn:hover{ background:#e6e6e6; }
    .results-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 18px;
      margin: 32px 0 0 0;
      align-items: stretch;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 0 18px rgba(0,0,0,.45);
      padding: 24px;
      min-height: 340px;
      color: var(--fg);
      font-size: 1.05rem;
      overflow-y: auto;
    }
    .panel-right {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 0 18px rgba(0,0,0,.45);
      margin-bottom: 10px;
    }
    .title { font-weight:700; line-height:1.35; }
    .meta { color:var(--muted); font-size:.92rem; }
    .actions { margin-top:6px; }
    .link { color:#e6e6e6; text-decoration:none; }
    .link:hover { text-decoration:underline; }
    .bottom-chat {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: transparent;
      padding: 18px 0;
      display: flex; justify-content: center; z-index: 100;
    }
    .bottom-inner {
      width: 100%; max-width: 600px; padding: 0 10px;
    }
    .chatbar {
      display: flex; gap: 10px; width: 100%;
      background: #121212; border: 2px solid var(--border); border-radius: 12px;
      padding: 5px 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    }
    .chatbar input {
      flex: 1; border: none; background: transparent; color: var(--fg);
      padding: 12px; font-size: 1rem; outline: none; caret-color: var(--focus);
      border-radius: 9999px;
    }
    .chatbar .btn {
      padding: 8px 18px; font-size: 1rem;
    }
    /* Chat bubbles and scroll styles */
    .chat-history-scroll {
      margin-bottom: 18px;
      max-height: 260px;
      overflow-y: auto;
      background: rgba(20,20,20,0.85);
      border-radius: 12px;
      padding: 12px 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
    }
    .chat-bubble {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
      max-width: 90%;
      padding: 10px 14px;
      border-radius: 14px;
      word-break: break-word;
      font-size: 1rem;
      box-shadow: 0 1px 6px rgba(0,0,0,0.10);
      background: #181818;
      border: 1px solid #232323;
      position: relative;
    }
    .user-bubble {
      align-self: flex-end;
      background: linear-gradient(90deg,#1a2a3a 60%,#223a5a 100%);
      color: #cce8ff;
      border: 1px solid #2a3a4a;
    }
    .ai-bubble {
      align-self: flex-start;
      background: linear-gradient(90deg,#232323 60%,#2a2a2a 100%);
      color: #ffe6b3;
      border: 1px solid #3a2a1a;
    }
    .chat-meta {
      font-size: .85rem;
      font-weight: 600;
      margin-bottom: 2px;
      opacity: 0.7;
    }
    .chat-text {
      white-space: pre-line;
    }
    .thinking-spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid #ffe6b3;
      border-top: 3px solid #232323;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 820px){
      .results-layout{ grid-template-columns: 1fr; }
      .panel-right{ max-width:none; min-width:0; }
    }
    footer{ margin:32px 0 128px; text-align:center; color:#b0b0b0; font-size:.88rem; }

    /* Custom scrollbar for chat history */
    .chat-history-scroll::-webkit-scrollbar {
      width: 10px;
      background: transparent;
    }
    .chat-history-scroll::-webkit-scrollbar-thumb {
      background: #2a2a2a;
      border-radius: 8px;
      border: 2px solid #181818;
    }
    .chat-history-scroll::-webkit-scrollbar-thumb:hover {
      background: #444;
    }
    .chat-history-scroll::-webkit-scrollbar-track {
      background: transparent;
    }
    /* Firefox */
    .chat-history-scroll {
      scrollbar-width: thin;
      scrollbar-color: #2a2a2a #181818;
    }
  </style>
</head>
<body>

  <!-- Top bar (brand links back to search page) -->
  <div class="topbar">
    <a class="brand-link" href="search.html" aria-label="Back to Search">
      <img src="Skynetlogo.jpg" alt="" class="brand-logo" />
      <span class="brand-text">Skynet Knowledge Engine</span>
    </a>
    <div class="top-right">
      <button id="changeRole" class="btn-link" type="button">Change role</button>
    </div>
  </div>

  <div class="wrap">
    <div id="mainContent"></div>
    <footer>&copy; 2025 Skynet &amp; Services â€” All Rights Reserved.</footer>
  </div>
  <div id="chatBarContainer"></div>

  <script>
    const API_BASE = 'http://localhost:5000/api';
    const qs = (s, el=document) => el.querySelector(s);
    let chatHistory = [];
    let lastResults = [];
    let lastSummary = '';
    let isResultsMode = false;

    // Markdown parsing function
    function parseMarkdown(text) {
      if (!text) return '';
      
      console.log('ðŸŽ¯ PARSING MARKDOWN:', text.substring(0, 100) + '...');
      
      // Simple, robust approach
      let result = text;
      
      // 1. Headers
      result = result.replace(/^### (.*$)/gm, '<h3 style="margin: 1.2rem 0 0.6rem; color: var(--fg); font-size: 1.1rem; font-weight: 600; border-left: 3px solid var(--accent); padding-left: 0.8rem;">$1</h3>');
      result = result.replace(/^## (.*$)/gm, '<h2 style="margin: 1.5rem 0 1rem; color: var(--fg); font-size: 1.3rem; font-weight: 700; border-bottom: 2px solid var(--accent); padding-bottom: 0.5rem;">$1</h2>');
      result = result.replace(/^# (.*$)/gm, '<h1 style="margin: 2rem 0 1.2rem; color: var(--fg); font-size: 1.5rem; font-weight: 700; text-align: center; border: 2px solid var(--accent); padding: 1rem; border-radius: 8px;">$1</h1>');
      
      // 2. Horizontal rules
      result = result.replace(/^---$/gm, '<hr style="border: none; height: 2px; background: linear-gradient(90deg, var(--accent), transparent); margin: 2rem 0;">');
      
      // 3. Lists
      result = result.replace(/^- (.*$)/gm, '<li style="margin: 0.4rem 0; color: var(--muted); line-height: 1.5; position: relative; padding-left: 1.2rem;">$1</li>');
      
      // 4. Group list items
      result = result.replace(/(<li[^>]*>.*<\/li>)(\s*<li[^>]*>.*<\/li>)*/g, function(match) {
        return `<ul style="margin: 1rem 0; padding-left: 0; list-style: none;">${match}</ul>`;
      });
      
      // 5. Inline formatting
      result = result.replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--accent); font-weight: 600; background: rgba(var(--accent-rgb), 0.1); padding: 0.1rem 0.3rem; border-radius: 3px;">$1</strong>');
      result = result.replace(/(?<!\*)\*(?!\*)([^*]+?)\*(?!\*)/g, '<em style="color: var(--muted); font-style: italic; font-weight: 500;">$1</em>');
      result = result.replace(/`([^`]+)`/g, '<code style="background: var(--bg-secondary); color: var(--accent); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: \'Monaco\', \'Menlo\', monospace; font-size: 0.9em; border: 1px solid var(--border);">$1</code>');
      
      // 6. Paragraphs
      const lines = result.split('\n');
      const processedLines = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (line.trim() === '') {
          processedLines.push('');
        } else if (line.startsWith('<')) {
          processedLines.push(line);
        } else {
          processedLines.push(`<p style="margin: 0.8rem 0; color: var(--muted); line-height: 1.6;">${line}</p>`);
        }
      }
      
      result = processedLines.join('\n');
      
      // 7. Clean up
      result = result
        .replace(/<p[^>]*><\/p>/g, '')
        .replace(/<p[^>]*>(<h[1-3][^>]*>.*<\/h[1-3]>)<\/p>/g, '$1')
        .replace(/<p[^>]*>(<ul[^>]*>.*<\/ul>)<\/p>/g, '$1')
        .replace(/<p[^>]*>(<hr[^>]*>)<\/p>/g, '$1');
      
      console.log('âœ… PARSED RESULT:', result.substring(0, 200) + '...');
      return result;
    }
    
    // Make function available globally for testing
    window.parseMarkdown = parseMarkdown;

    function renderInitialSearch() {
      qs('#mainContent').innerHTML = `
        <div class="centered-search">
          <h2 style="margin-bottom:1.5rem;color:#fff;">Ask about space biology</h2>
          <form class="searchbar" id="searchForm">
            <input id="searchInput" type="text" placeholder="Type your question..." autocomplete="off" />
            <button class="btn" type="submit">Search</button>
          </form>
        </div>
      `;
      qs('#chatBarContainer').innerHTML = '';
      qs('#searchForm').addEventListener('submit', e => {
        e.preventDefault();
        const val = qs('#searchInput').value.trim();
        if(!val) return;
        startResultsMode(val);
      });
    }

    function renderResultsLayout(summary, results, isThinking=false) {
      // Improved chat bubble style and scroll
      const historyHtml = chatHistory.slice(0, -1).map((msg, i) => {
        const isUser = msg.role === 'user';
        const content = isUser ? msg.content : parseMarkdown(msg.content);
        return `<div class=\"chat-bubble ${isUser ? 'user-bubble' : 'ai-bubble'}\">\n      <div class=\"chat-meta\">${isUser ? 'You' : 'AI'}</div>\n      <div class=\"chat-text\">${content}</div>\n    </div>`;
      }).join('');
      // Add thinking bubble if loading
      const thinkingHtml = isThinking ? `<div class=\"chat-bubble ai-bubble\"><div class=\"chat-meta\">AI</div><div class=\"chat-text\"><span class=\"thinking-spinner\"></span> Thinking...</div></div>` : '';

      qs('#mainContent').innerHTML = `
        <div class=\"results-layout\">
          <div class=\"panel\" id=\"summaryPanel\">
            <div id=\"chatHistoryPanel\" class=\"chat-history-scroll\">
              ${historyHtml}
              ${thinkingHtml}
            </div>
            <div id=\"currentSummary\">${isThinking ? '' : parseMarkdown(summary)}</div>
          </div>
          <div class=\"panel panel-right\" id=\"resultsPanel\">
            ${results.map(renderResultCard).join('')}
          </div>
        </div>
      `;
      // Auto-scroll to bottom of chat history
      setTimeout(() => {
        const panel = qs('#chatHistoryPanel');
        if(panel) panel.scrollTop = panel.scrollHeight;
      }, 50);
      renderChatBar();
    }

    function renderResultCard(p) {
      return `
        <div class="card">
          <div class="title">${p.title || 'Untitled'}</div>
          <div class="meta">${p.pmcid ? 'PMC ID: ' + p.pmcid : ''}</div>
          <div class="actions">
            <a class="link" href="${p.url}" target="_blank">Open Paper</a>
          </div>
        </div>
      `;
    }

    function renderChatBar() {
      qs('#chatBarContainer').innerHTML = `
        <div class="bottom-chat">
          <div class="bottom-inner">
            <form class="chatbar" id="chatForm">
              <input id="chatInput" type="text" placeholder="Ask a follow-up..." autocomplete="off" />
              <button class="btn" type="submit">Send</button>
            </form>
          </div>
        </div>
      `;
      qs('#chatForm').addEventListener('submit', e => {
        e.preventDefault();
        const val = qs('#chatInput').value.trim();
        if(!val) return;
        sendFollowup(val);
        qs('#chatInput').value = '';
      });
    }

    async function startResultsMode(firstQuestion) {
      isResultsMode = true;
      chatHistory = [{role:'user', content:firstQuestion}];
      renderResultsLayout('', [], true); // Show thinking
      qs('#chatBarContainer').innerHTML = '';
      try {
        const res = await fetch(`${API_BASE}/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: firstQuestion,
            messages: chatHistory,
            role: 'Researcher',
            top_docs: 5
          })
        });
        const data = await res.json();
        console.log('API response:', data); // Debug log
        lastSummary = data.summary || 'No summary.';
        lastResults = data.results || [];
        // Add AI response to chatHistory
        chatHistory.push({role:'assistant', content:lastSummary});
        if (!data.summary || data.summary === 'No summary.') {
          lastSummary += '<br><span style="color:#ff8080">(No summary received from backend. Check API key and backend logs.)</span>';
        }
        renderResultsLayout(lastSummary, lastResults);
      } catch (err) {
        qs('#mainContent').innerHTML = `<div style='color:#ff8080;text-align:center;margin-top:60px;'>Error fetching summary.<br>${err}</div>`;
      }
    }

    async function sendFollowup(content){
      chatHistory.push({role:'user', content});
      renderResultsLayout('', lastResults, true); // Show thinking
      try {
        const res = await fetch(`${API_BASE}/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: content,
            messages: chatHistory,
            role: 'Researcher',
            top_docs: 5
          })
        });
        const data = await res.json();
        console.log('API response:', data); // Debug log
        lastSummary = data.summary || 'No summary.';
        lastResults = data.results || [];
        // Add AI response to chatHistory
        chatHistory.push({role:'assistant', content:lastSummary});
        if (!data.summary || data.summary === 'No summary.') {
          lastSummary += '<br><span style="color:#ff8080">(No summary received from backend. Check API key and backend logs.)</span>';
        }
        renderResultsLayout(lastSummary, lastResults);
      } catch (err) {
        qs('#summaryPanel').innerHTML = `<div style='color:#ff8080;text-align:center;margin-top:60px;'>Error fetching summary.<br>${err}</div>`;
      }
    }

    // Utility to get query param
    function getQueryParam(name) {
      const url = window.location.search;
      const params = new URLSearchParams(url);
      return params.get(name);
    }

    // On page load, check for 'q' param
    const initialQ = getQueryParam('q');
    if (initialQ && initialQ.trim()) {
      startResultsMode(initialQ.trim());
    } else {
      renderInitialSearch();
    }

    // Optional: role switch (kept top-right)
    qs('#changeRole').addEventListener('click', ()=>{
      sessionStorage.removeItem('nassRole');
      location.href = 'role.html';
    });
  </script>
</body>
</html>