<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skynet Knowledge Engine</title>
  <style>
    :root {
      --fg:#f2f2f2; --muted:#b3b3b3;
      --card:#141414; --radius:14px; --border:#2a2a2a;
      --accent:#ffffff;          /* buttons/primary */
      --focus:#EFF9F0;           /* search focus outline */
    }
    body{
      margin:0;
      background-color: #000; /* fallback */
      color: var(--fg);
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex; flex-direction: column;

      /* Background image + overlay (adjust path/extension as needed) */
      background-image:
        linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,.65)),
        url("Spacebackground.jpg");
      background-position: center center;
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    /* TOP BAR */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px;
    }
    .left-wrap{ display:flex; align-items:center; gap:10px; position:relative; }
    .hamburger{
      border:1px solid var(--border); background:transparent; color:var(--fg);
      border-radius:10px; padding:8px 10px; cursor:pointer; font-size:18px; line-height:1;
    }
    .hamburger:hover{ background:#1a1a1a; }
    .brand-logo{ height:22px; width:auto; object-fit:contain; border-radius:3px; pointer-events:none; user-select:none; }
    .hamburger-label{ color:var(--muted); font-size:.95rem; user-select:none; padding:6px 8px; border-radius:8px; cursor:default; pointer-events:none; }

    .top-right{ display:flex; align-items:center; gap:10px; }
    .role-pill{
      display:inline-flex; align-items:center; gap:.45rem; padding:.4rem .7rem;
      border-radius:9999px; background:#1a1a1a; color:#d9d9d9;
      font-size:.85rem; border:1px solid var(--border);
    }
    .btn-link{
      border:1px solid var(--border); background:transparent; color:#e6e6e6;
      padding:.4rem .7rem; border-radius:9999px; cursor:pointer; font-size:.85rem;
    }
    .btn-link:hover{ background:#1a1a1a; }

    /* Dropdown */
    .menu{
      position:absolute; top:48px; left:0;
      background:var(--card); border:1px solid var(--border); border-radius:12px;
      box-shadow:0 10px 28px rgba(0,0,0,.6);
      min-width:220px; padding:8px; display:none; z-index:10;
    }
    .menu.open{ display:block; }
    .menu a{ display:block; color:var(--fg); text-decoration:none; padding:10px 12px; border-radius:8px; }
    .menu a:hover{ background:#1a1a1a; }

    /* Main layout */
    .wrap{max-width:960px; margin:0 auto; padding:16px 16px 48px; width:100%;}
    header{ text-align:center; margin:28px 0; }
    h1{ font-family:Helvetica, Arial, sans-serif; font-size:2.25rem; margin:0 0 8px; }
    .sub{ color:var(--muted); margin:6px 0 0; font-size:1rem; }

    /* Search box */
    .search-wrap{ display:flex; justify-content:center; margin:28px 0 16px; }
    .searchbar{
      display:flex; align-items:center; gap:10px;
      width:min(720px, 92vw);
      background:#121212;
      border:2px solid var(--border);   /* thicker so the highlight pops */
      border-radius:9999px;
      padding:8px 10px;
      box-shadow:0 10px 28px rgba(0,0,0,.5);
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .searchbar:focus-within{
      border-color: var(--focus);
      box-shadow:
        0 0 0 3px var(--focus),
        0 10px 28px rgba(0,0,0,.5);
    }
    .searchbar input{ flex:1; border:none; background:transparent; color:var(--fg); padding:14px 14px; font-size:1.05rem; outline:none; caret-color: var(--focus); }
    .btn{ border:none; border-radius:9999px; background:var(--accent); color:#000; font-weight:700; padding:12px 18px; font-size:1rem; cursor:pointer; }
    .btn:hover{ background:#e6e6e6; }

    /* Chips & recent */
    .chips, .recent{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
      margin:4px 0 28px;
    }
    .chip, .recent button{
      background:#1a1a1a; border:1px solid var(--border); color:var(--muted);
      font-size:.85rem; padding:.35rem .7rem; border-radius:9999px; cursor:pointer;
    }
    .chip:hover, .recent button:hover{ background:#202020; color:#e6e6e6; }
    .recent-label{ color:var(--muted); font-size:.85rem; margin:0 6px; }

    /* Sections */
    h2{ font-family:Helvetica, Arial, sans-serif; font-size:1.25rem; margin:18px 0 12px; text-align:left; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:14px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:0 0 18px rgba(0,0,0,.45); display:flex; flex-direction:column; gap:6px; }
    .title{ font-weight:700; line-height:1.35; }
    .meta{ color:var(--muted); font-size:.92rem; }
    .tags{ display:flex; gap:.4rem; flex-wrap:wrap; margin-top:2px; }
    .tag{ background:#1a1a1a; border:1px solid var(--border); color:#bdbdbd; font-size:.8rem; padding:.2rem .45rem; border-radius:9999px; }
    .actions{ margin-top:6px; display:flex; gap:.6rem; flex-wrap: wrap; }
    .link{ color:#e6e6e6; text-decoration:none; }
    .link:hover{ text-decoration:underline; }

    .results-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .count{ color:var(--muted); font-size:.95rem; }
    .empty{ color:var(--muted); text-align:center; margin:18px 0 28px; }
    footer{ margin:32px 0 8px; text-align:center; color:var(--muted); font-size:.9rem; }

    /* Markdown rendering styles */
    #aiSummary h1, #aiSummary h2, #aiSummary h3 { scroll-margin-top: 2rem; }
    #aiSummary strong { font-weight: 600; }
    #aiSummary em { font-style: italic; }
    #aiSummary a { transition: all 0.2s ease; }
    #aiSummary a:hover { color: var(--fg) !important; border-bottom-color: var(--fg) !important; }
    #aiSummary p:last-child, #aiSummary div:last-child { margin-bottom: 0; }

    /* Knowledge Tree modal */
    #bubbleModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999; }
    #bubbleShell{ position:absolute; inset:6% 4%; background:#0b0b0d; border:1px solid var(--border); border-radius:12px; padding:12px; }
    #bubbleHeader{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    #bubbleMount{ width:100%; height:calc(100% - 40px); }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="topbar">
    <div class="left-wrap">
      <button class="hamburger" id="hamburger" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Open menu">â˜°</button>
      <img src="Skynetlogo.jpg" alt="" class="brand-logo" aria-hidden="true" />
      <span class="hamburger-label">Skynet Knowledge Engine</span>
      <nav id="menu" class="menu" aria-label="Main menu">
        <a href="#" role="menuitem">Home</a>
        <a href="#" role="menuitem">Datasets</a>
        <a href="#" role="menuitem">About</a>
      </nav>
    </div>
    <div class="top-right">
      <div id="rolePill" class="role-pill" style="display:none"></div>
      <button id="changeRole" class="btn-link" type="button">Change role</button>
    </div>
  </div>

  <div class="wrap">
    <header>
      <!-- IDs used by JS to swap text based on role -->
      <h1 id="pageTitle">Explore Space Biology</h1>
      <p class="sub" id="pageSub">Search NASA bioscience literature and discover key insights.</p>
    </header>

    <!-- Search -->
    <div class="search-wrap">
      <form class="searchbar" id="searchForm" role="search">
        <input id="q" type="search" placeholder="Search publications (e.g., microgravity gene expression, omics, radiation)" autocomplete="off" />
        <button class="btn" type="submit">Search</button>
        <!-- NEW: Global Knowledge Tree trigger -->
        <button class="btn" type="button" id="openTree" style="margin-left:8px;">Knowledge Tree</button>
      </form>
    </div>

    <!-- Suggested queries -->
    <div class="chips" id="chips">
      <button class="chip" data-q="microgravity gene expression">microgravity gene expression</button>
      <button class="chip" data-q="radiation effects plants">radiation effects plants</button>
      <button class="chip" data-q="omics spaceflight mice">omics spaceflight mice</button>
      <button class="chip" data-q="automated phenotyping ISS">automated phenotyping ISS</button>
    </div>

    <!-- Recent searches -->
    <div class="recent" id="recentWrap" style="display:none">
      <span class="recent-label">Recent:</span>
      <div id="recentBtns" style="display:flex; gap:8px; flex-wrap:wrap"></div>
    </div>

    <!-- Results -->
    <section id="resultsSection" style="display:none">
      <div class="results-head">
        <h2 id="resultsTitle">Results</h2>
        <div class="count" id="resultsCount"></div>
      </div>
      <div class="grid" id="resultsGrid"></div>
      <div class="empty" id="emptyMsg" style="display:none">No results found. Try a broader query or pick a suggested topic above.</div>
    </section>

    <!-- Trending (shown when no search yet) -->
    <section id="trendingSection">
      <h2>Trending publications</h2>
      <div class="grid" id="trendGrid"></div>
    </section>

    <footer>&copy; 2025 Skynet &amp; Services â€” All Rights Reserved.</footer>
  </div>

  <!-- Knowledge Tree modal -->
  <div id="bubbleModal" aria-hidden="true">
    <div id="bubbleShell">
      <div id="bubbleHeader">
        <h3 style="margin:0; color:#fff;">Knowledge Tree</h3>
        <button id="bubbleClose" class="btn-link" type="button">Close</button>
      </div>
      <div id="bubbleMount"></div>
    </div>
  </div>

  <!-- D3 for circle packing -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

  <script>
    /** ---------- API Configuration ---------- */
    const API_BASE = 'http://localhost:5000/api';
    let PUBLICATIONS = []; // Will be loaded from trending endpoint

    /** ---------- Helpers ---------- */
    const qs = (sel, el=document) => el.querySelector(sel);

    function renderCard(p) {
      // Handle both demo data format and API response format
      const title = p.title || 'Untitled';
      const meta = p.authors ? `${p.authors} â€” ${p.year} â€¢ ${p.venue}` : `PMC ID: ${p.pmcid}`;
      const tags = p.tags ? p.tags.map(t => `<span class="tag">${t}</span>`).join("") : 
                   (p.section ? `<span class="tag">${p.section}</span>` : '');

      return `
        <article class="card">
          <div class="title">${title}</div>
          <div class="meta">${meta}</div>
          <div class="tags">${tags}</div>
          <div class="actions">
            <a class="link" href="${p.url}" target="_blank" rel="noopener">Open Paper</a>
          </div>
          ${p.preview ? `<div style="margin-top: 8px; font-size: 0.9rem; color: #b3b3b3;">${p.preview}</div>` : ''}
        </article>`;
    }

    function parseMarkdown(text) {
      if (!text) return '';
      return text
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/^### (.*$)/gim, '<h3 style="margin: 1rem 0 0.5rem; color: var(--fg); font-size: 1.1rem; font-weight: 600;">$1</h3>')
        .replace(/^## (.*$)/gim, '<h2 style="margin: 1.2rem 0 0.8rem; color: var(--fg); font-size: 1.2rem; font-weight: 600;">$1</h2>')
        .replace(/^# (.*$)/gim, '<h1 style="margin: 1.5rem 0 1rem; color: var(--fg); font-size: 1.3rem; font-weight: 600;">$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--accent); font-weight: 600;">$1</strong>')
        .replace(/(?<!\*)\*(?!\*)([^*]+?)\*(?!\*)/g, '<em style="color: var(--muted); font-style: italic;">$1</em>')
        .replace(/^(\d+)\.\s+(.*$)/gim, '<div style="margin: 0.5rem 0; padding-left: 1.5rem;"><span style="color: var(--accent); font-weight: bold; margin-right: 0.5rem;">$1.</span> <span style="color: var(--muted);">$2</span></div>')
        .replace(/^[-*]\s+(.*$)/gim, '<div style="margin: 0.3rem 0; padding-left: 1rem;"><span style="color: var(--accent); margin-right: 0.5rem;">â€¢</span> <span style="color: var(--muted);">$1</span></div>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" style="color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent);" target="_blank" rel="noopener">$1</a>')
        .replace(/\n\n/g, '</p><p style="margin: 0.8rem 0; color: var(--muted); line-height: 1.6;">')
        .replace(/\n/g, '<br>')
        .replace(/^(?!<[h1-3]|<div|<p)(.*)$/gim, '<p style="margin: 0.8rem 0; color: var(--muted); line-height: 1.6;">$1</p>')
        .replace(/<p[^>]*><\/p>/g, '')
        .replace(/<p[^>]*>(<h[1-3][^>]*>.*<\/h[1-3]>)<\/p>/g, '$1')
        .replace(/<p[^>]*>(<div[^>]*>.*<\/div>)<\/p>/g, '$1');
    }

    async function searchAPI(query, role = 'Researcher') {
      try {
        const response = await fetch(`${API_BASE}/search`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ query, role, top_docs: 10 })
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error('Search API error:', error);
        return { results: [], summary: 'Search service unavailable.', count: 0 };
      }
    }

    function setURLQuery(q) {
      const url = new URL(location.href);
      if (q) url.searchParams.set("q", q); else url.searchParams.delete("q");
      history.replaceState(null, "", url.toString());
    }

    function addRecent(q) {
      if (!q) return;
      const key = "recentSearches";
      const list = JSON.parse(sessionStorage.getItem(key) || "[]");
      const next = [q, ...list.filter(x => x !== q)].slice(0, 6);
      sessionStorage.setItem(key, JSON.stringify(next));
      renderRecents();
    }

    function renderRecents() {
      const key = "recentSearches";
      const list = JSON.parse(sessionStorage.getItem(key) || "[]");
      const wrap = qs("#recentWrap");
      const btns = qs("#recentBtns");
      if (!list.length) { wrap.style.display = "none"; return; }
      wrap.style.display = "flex";
      btns.innerHTML = list.map(q => `<button type="button">${q}</button>`).join("");
    }

    async function runSearch(q) {
      // Get current role
      let currentRole = 'Researcher';
      try {
        const roleData = JSON.parse(sessionStorage.getItem("nassRole"));
        if (roleData && roleData.role) currentRole = roleData.role;
      } catch (e) {}

      qs("#trendingSection").style.display = "none";
      qs("#resultsSection").style.display = "block";
      qs("#resultsTitle").textContent = `Searching for: "${q}"...`;
      qs("#resultsCount").textContent = "Loading...";
      qs("#resultsGrid").innerHTML = '<div style="text-align: center; color: #b3b3b3;">Searching...</div>';
      qs("#emptyMsg").style.display = "none";

      const data = await searchAPI(q, currentRole);

      qs("#resultsTitle").textContent = `Results for: "${q}"`;
      qs("#resultsCount").textContent = `${data.count} ${data.count === 1 ? "match" : "matches"}`;

      const existingSummary = qs("#aiSummary");
      if (existingSummary) existingSummary.remove();

      const grid = qs("#resultsGrid");
      if (data.results && data.results.length > 0) {
        if (data.summary && data.summary !== 'Search service unavailable.') {
          const summaryDiv = document.createElement('div');
          summaryDiv.id = 'aiSummary';
          summaryDiv.style.cssText = 'background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin: 1rem 0; box-shadow: 0 0 18px rgba(0,0,0,.45);';
          summaryDiv.innerHTML = `
            <h3 style="margin: 0 0 1rem; color: var(--fg); font-size: 1.2rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">ðŸ¤– AI Summary</h3>
            <div style="color: var(--muted); line-height: 1.6;">${parseMarkdown(data.summary)}</div>
          `;
          grid.parentNode.insertBefore(summaryDiv, grid);
        }
        grid.innerHTML = data.results.map(renderCard).join("");
        qs("#emptyMsg").style.display = "none";
      } else {
        grid.innerHTML = '';
        qs("#emptyMsg").style.display = "block";
      }

      setURLQuery(q);
      addRecent(q);
    }

    async function renderTrending() {
      try {
        const response = await fetch(`${API_BASE}/trending`);
        if (response.ok) {
          const data = await response.json();
          PUBLICATIONS = data.trending || [];
          qs("#trendGrid").innerHTML = PUBLICATIONS.slice(0, 8).map(renderCard).join("");
        } else {
          qs("#trendGrid").innerHTML = '<div style="text-align: center; color: #b3b3b3;">Loading trending publications...</div>';
        }
      } catch (error) {
        console.error('Trending API error:', error);
        qs("#trendGrid").innerHTML = '<div style="text-align: center; color: #b3b3b3;">Unable to load trending publications.</div>';
      }
    }

    /* ---------- Knowledge Tree (global) ---------- */
    // Open the tree and render drill-down bubbles
    qs('#openTree').addEventListener('click', async () => {
      const modal = qs('#bubbleModal'), mount = qs('#bubbleMount');
      modal.style.display = 'block';
      mount.innerHTML = '<div style="padding:12px;color:#b3b3b3;">Loadingâ€¦</div>';
      try {
        const res = await fetch(`${API_BASE}/tree`);
        const tree = await res.json();
        mount.innerHTML = '';
        renderDrillDownBubbles(mount, tree);
      } catch (e) {
        console.error('Tree API error', e);
        mount.innerHTML = '<div style="padding:12px;color:#b3b3b3;">Unable to load knowledge tree.</div>';
      }
    });

    // Close modal
    qs('#bubbleClose').addEventListener('click', () => {
      qs('#bubbleModal').style.display = 'none';
    });

    // Drill-down bubble viewer: Topic -> Subtopic -> ... -> Papers
    function renderDrillDownBubbles(container, rootData) {
      const d3 = window.d3;
      const width = container.clientWidth, height = container.clientHeight;
      const stack = [rootData]; // breadcrumb stack

      function draw(current) {
        container.innerHTML = '';
        const svg = d3.select(container).append('svg')
          .attr('viewBox', `0 0 ${width} ${height}`)
          .style('width','100%').style('height','100%');

        // Breadcrumbs
        const bc = svg.append('g').attr('transform','translate(12,20)');
        bc.selectAll('text').data(stack).enter().append('text')
          .attr('x', (d,i)=> i*180)
          .style('font-size','12px')
          .style('fill','#ddd')
          .text(d => d.label || d.id)
          .style('cursor','pointer')
          .on('click', (_, d) => {
            const idx = stack.findIndex(s => s.id === d.id);
            stack.splice(idx+1);
            draw(stack[stack.length-1]);
          });

        const root = d3.hierarchy(current).sum(d => Math.max(1, d.size));
        d3.pack().size([width, height]).padding(8)(root);

        // Only draw the first layer of children for current node
        const nodes = svg.selectAll('g.node')
          .data(root.descendants().filter(d => d.depth === 1))
          .enter().append('g').attr('class','node')
          .attr('transform', d => `translate(${d.x},${d.y})`);

        nodes.append('circle')
          .attr('r', d => d.r)
          .attr('fill', d => d.data.type === 'paper' ? '#e3f2fd' : '#f3e5f5')
          .attr('stroke', '#9ea3a8')
          .attr('stroke-width', 2)
          .on('click', (_, d) => {
            const nd = d.data;
            if (nd.type === 'paper' && nd.link) {
              window.open(nd.link, '_blank');
              return;
            }
            if (nd.children && nd.children.length) {
              stack.push(nd);
              draw(nd);
            }
          });

        nodes.append('text')
          .attr('text-anchor','middle').attr('dy','.35em')
          .style('font-size','10px').style('fill','#111')
          .text(d => (d.data.label || '').slice(0, Math.max(6, Math.floor(d.r/4))));
      }

      draw(stack[0]);
    }

    /** ---------- Init ---------- */
    // role pill + role-aware header
    (function(){
      let roleText = "";
      try {
        const r = JSON.parse(sessionStorage.getItem("nassRole"));
        if (r && r.role) {
          roleText = String(r.role);
          const pill = qs("#rolePill");
          pill.textContent = roleText;
          pill.style.display = "inline-flex";
        }
      } catch(_) {}

      const titleEl = qs("#pageTitle");
      const subEl   = qs("#pageSub");
      const roleNorm = roleText.toLowerCase();

      if (roleNorm.includes("manager") || roleNorm.includes("investor")) {
        titleEl.textContent = "Discover Investment Opportunities";
        subEl.textContent   = "Find promising technologies, market opportunities, and future growth areas in space biology.";
      } else {
        titleEl.textContent = "Explore Space Biology";
        subEl.textContent   = "Search NASA bioscience literature and discover key insights.";
      }
    })();

    renderTrending();
    renderRecents();

    // change role
    qs("#changeRole").addEventListener("click", () => {
      sessionStorage.removeItem("nassRole");
      location.href = "role.html";
    });

    // chips
    qs("#chips").addEventListener("click", (e) => {
      const chip = e.target.closest("[data-q]");
      if (!chip) return;
      const q = chip.getAttribute("data-q");
      qs("#q").value = q;
      runSearch(q);
    });

    // recent buttons
    qs("#recentBtns").addEventListener("click", (e) => {
      if (e.target.tagName !== "BUTTON") return;
      const q = e.target.textContent;
      qs("#q").value = q;
      runSearch(q);
    });

    // form submit
    qs("#searchForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const q = qs("#q").value.trim();
      if (!q) return;
      runSearch(q);
    });

    // load q from URL if present
    (function(){
      const q = new URLSearchParams(location.search).get("q");
      if (q) { qs("#q").value = q; runSearch(q); }
    })();

    // dropdown
    const hamburger = qs("#hamburger");
    const menu = qs("#menu");
    hamburger.addEventListener("click", () => {
      const isOpen = menu.classList.toggle("open");
      hamburger.setAttribute("aria-expanded", isOpen ? "true" : "false");
    });
    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target) && e.target !== hamburger) {
        menu.classList.remove("open");
        hamburger.setAttribute("aria-expanded", "false");
      }
    });
  </script>
</body>
</html>
